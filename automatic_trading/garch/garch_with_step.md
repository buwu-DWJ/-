# 一. 加入分段式开仓后的GARCH模型回测

## 1.1 分段式做法

根据当前持有的 cashvega 以及该时刻得到的预测值的方向决定要做的目标cashvega仓位：

能做的cashvega仓位为**[-30000, -25000, -15000, 0, 15000, 25000, 30000]**, 

举例而言

- 当前cashvega为**-25000**，若预测值为**正向**，则cashvega调整为**-15000**
- 当前cashvega为**-25000**，若预测值为**负向**，则cashvega调整为**-30000**
- 当前cashvega为**-30000**，若预测方向为**负向**，则**不做操作**



### 加入调仓操作

若某时刻的cashvega绝对值低于开仓时要做的cashvega到一定程度，则进行调仓操作，即将仓位全部调到该时刻平值合约上；

#### 不调仓不分阶段vega

|          | 年化收益 | 最大回撤 |
| :------: | :------: | :------: |
| 次月合约 |  11.8%   |  5.45%   |



#### 分阶段vega，加入调仓操作，次月

| 当前cashvega < 开仓cashvega * x |              年化收益              | 最大回撤 |
| :-----------------------------: | :--------------------------------: | :------: |
|               0.5               |               8.48%                |  -8.8%   |
|               0.6               |               6.54%                |  -9.2%   |
|               0.7               |               6.77%                |  -9.1%   |
|               0.8               |               7.02%                |  -8.6%   |
|               0.9               |               8.35%                |  -8.4%   |
|             不调仓              | <font color='red'>**8.48%**</font> |  -8.8%   |

从结果看，不调仓的年化是最高的，收益回撤比最高的是按 0.9 调仓。



## 1.2 结果对比

**之前**回测的净值图（无调仓，无分阶段vega，次月）

![image-20221028093601257](C:\Users\dingwenjie\AppData\Roaming\Typora\typora-user-images\image-20221028093601257.png)



**本次**回测的净值图（不调仓，分阶段vega，次月）

![image-20221028130550271](C:\Users\dingwenjie\AppData\Roaming\Typora\typora-user-images\image-20221028130550271.png)



#### 第一次大回撤：2020.3.12~2020.3.25

![image-20221028133132813](C:\Users\dingwenjie\AppData\Roaming\Typora\typora-user-images\image-20221028133132813.png)



大部分亏损来自于2020.3.16当天，该天没有满足条件的信号，仓位没变化；而前一天2020.3.13的13:15有一次正信号，cashvega仓位从-30000变为-25000，2020.3.13结束时的仓位是-25000，该较大的负vega仓位维持了数天，覆盖了方框中的一波大跌；

而上次回测中同一时段，是大幅盈利的，这是因为根据之前回测中的开仓设定，在2020.3.13的13:15 cashvega仓位直接变为+30000且2020.3.16全天持有该仓位；

所以对比来看，**之前回测中的此段盈利是不太合理的**。



#### 第二次大回撤：2022.3.4~2022.3.15

![image-20221028133444039](C:\Users\dingwenjie\AppData\Roaming\Typora\typora-user-images\image-20221028133444039.png)



2022.3.4开始时就持有-30000cashvega，2022.3.7，3.8两天没信号，标的大跌，有大幅亏损，这一段亏损与上次回测是一致的，但上一次回测中经历了这次亏损后立刻赚了回去，原因仍旧在于在2022.3.14与2022.3.15有正信号，原来的回测直接将仓位变为+30000，而本次回测只是减仓，仍旧维持了至少-15000的cashvega，而标的仍旧有一波下跌，所以仍有大幅亏损；



#### 第三次大回撤：2022.4.22~2022.4.25

![image-20221028140336659](C:\Users\dingwenjie\AppData\Roaming\Typora\typora-user-images\image-20221028140336659.png)



2022.4.22，2022.4.25两天都没有满足条件的信号，仓位没变，都是持有-30000cashvega，标的在2022.4.25有大跌，该段时间的大幅亏损与上次回测一致。



## 1.3 总结

加入了调仓并没有对回测结果有太大的提升；

分阶段式地调 vega 对回测结果影响比较大，与上次回测进行比较后，可以发现：

- 之前净值图中开始一部分的盈利不太合理；
- 新的净值图在大部分时间都比原来的更加平滑，且前大半段中是稳定盈利；
- 在回测时段末期中出现了两次较大的回撤，前一个回撤一部分是阶段式vega所导致的，后一个回撤则与上次回测一样，是由于该时段所有信号都被屏蔽导致在大跌期间持有错误的仓位；







# 二. 样本外测试(20220707~20221028)

## 2.1 样本外用上述策略回测

| 开仓/换仓时间    | cashvega   | 该日净值 |
| ---------------- | ---------- | -------- |
| 2022-8-2  13:00  | -15000     | 10000925 |
| 2022-8-17  14:45 | -25000     | 10090947 |
| 2022-8-23 13:30  | -30000     | 10145988 |
| 2022-8-24        | 到期日平仓 | 10157484 |
| 2022-10-19 10:15 | -15000     |          |
| 2022-10-19 11:15 | -25000     |          |
| 2022-10-19 13:15 | -30000     | 10139523 |
| 2022-10-26       | 到期日平仓 | 9945507  |
| 2022-10-27 10:15 | -15000     |          |
| 2022-10-27 10:30 | -25000     |          |
| 2022-10-27 14:30 | -30000     | 9940040  |
| 2022-10-28       |            | 9874176  |



![image-20221102162348160](C:\Users\dingwenjie\AppData\Roaming\Typora\typora-user-images\image-20221102162348160.png)



年化收益率 **-4.1%**，最大回撤**-2.79%**

发生主要亏损的两天：

- 2022.10.24：标的从 3.802 掉到 3.704，共亏 206724
- 2022.10.28：标的从 3.690 掉到 3.604，共亏 65864

可以看到样本外测试中开仓次数非常少，后面考虑

- **修改** iv 屏蔽的阈值范围，**修改**成有正向预测时 iv 高于上阈值或者有负向预测时 iv 低于下阈值则跳过；
- **修改** 预测值屏蔽的阈值范围

## 2.2 样本内修改阈值后测试

修改 iv 屏蔽条件

| iv屏蔽的阈值 | 年化                                | 最大回撤 |
| ------------ | ----------------------------------- | -------- |
| [40, 60]     | 11.47%                              | -6.12%   |
| [35, 65]     | <font color='red'>**12.20%**</font> | -6.12%   |
| [30, 70]     | 10.24%                              | -6.12%   |
| [25, 75]     | 8.83%                               | -6.12%   |
| [20, 80]     | 8.50%                               | -6.12%   |

在上述[35,65]的基础上修改预测值屏蔽条件

| 预测值屏蔽的阈值 | 年化                                | 最大回撤 |
| ---------------- | ----------------------------------- | -------- |
| [40, 60]         | 12.20%                              | -6.12%   |
| [35, 65]         | 13.17%                              | -6.12%   |
| [30, 70]         | 13.17%                              | -6.12%   |
| [25, 75]         | <font color='red'>**13.18%**</font> | -6.12%   |
| [20, 80]         | 9.76%                               | -6.12%   |

![image-20221104134715074](C:\Users\dingwenjie\AppData\Roaming\Typora\typora-user-images\image-20221104134715074.png)



## 2.3 修改屏蔽条件后样本外测试

| 开仓/换仓时间     | cashvega   | 该日净值 |
| ----------------- | ---------- | -------- |
| 2022-7-22  9:45   | 15000      |          |
| 2022-7-22  10:30  | 25000      |          |
| 2022-7-22  14:45  | 30000      | 10008551 |
| 2022-7-25  9:30   | 25000      |          |
| 2022-7-25  10:30  | 30000      |          |
| 2022-7-25  13:30  | 25000      |          |
| 2022-7-25  14:30  | 15000      | 10001646 |
| 2022-7-26  9:30   | 25000      |          |
| 2022-7-26  10:15  | 30000      | 9961935  |
| 2022-7-27         | 到期日平仓 | 9965915  |
| 2022-8-2 10:30    | -15000     |          |
| 2022-8-2 13:30    | -25000     | 9960497  |
| 2022-8-3  10:15   | -30000     | 9987153  |
| 2022-8-24         | 到期日平仓 | 10219121 |
| 2022-9-6  9:30    | 15000      |          |
| 2022-9-6  9:45    | 25000      |          |
| 2022-9-6  10:45   | 30000      | 10201214 |
| 2022-9-23  14:00  | 25000      | 10233773 |
| 2022-9-26  13:15  | 15000      |          |
| 2022-9-26  13:30  | 0          | 10209008 |
| 2022-10-20  10:30 | 15000      |          |
| 2022-10-20  13:15 | 25000      | 10225673 |
| 2022-10-21  9:45  | 15000      | 10235649 |
| 2022-10-24  9:45  | 0          | 10245210 |
| 2022-10-25  13:15 | -15000     |          |
| 2022-10-25  14:45 | -25000     | 10245895 |
| 2022-10-26        | 到期日平仓 | 10251387 |
| 2022-10-27  10:15 | -15000     |          |
| 2022-10-27  10:30 | -25000     |          |
| 2022-10-27  14:30 | -30000     | 10245920 |
| 2022-10-28        |            | 10180056 |

![image-20221103134037443](C:\Users\dingwenjie\AppData\Roaming\Typora\typora-user-images\image-20221103134037443.png)



年化收益率 **5.8%**，最大回撤 **-0.85%**











